version: '3.7'
services:
  iris: 
    build: 
      context: .
      args:
        - IMAGE=containers.intersystems.com/intersystems/irishealth:2023.1.0.229.0
    environment:
      - IRIS_USERNAME=fhir
      - IRIS_PASSWORD=fhir
      - IRIS_NAMESPACE=FHIRSERVER
      - IRIS_FHIRSQLSCHEMA=fhir
    restart: unless-stopped
    ports:
      - 33782:1972
      - 33783:52773
      - 33784:53773
    volumes:
      - ~/iris.key:/usr/irissys/mgr/iris.key
      - ./init.db/:/docker-entrypoint-initdb.d/
      - ./:/home/irisowner/ml-on-fhir/
      - irissys:/usr/irissys
    working_dir: /home/irisowner/ml-on-fhir

  synthea:
    profiles:
      - cli
    build: 
      context: .
      dockerfile: Dockerfile-synthea
    command: [ "bash" ]
    volumes:
      - ./data/fhir:/output
  
  notebook:
    build: 
      context: notebook
      dockerfile: dockerfile
    ports:
      - "8888:8888"
    volumes:
      - ./notebook/Notebooks:/Notebooks
    command: "start-notebook.sh --NotebookApp.token='' --NotebookApp.password='' --notebook-dir=/Notebooks"

volumes:
  irissys: 